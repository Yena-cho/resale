<?xml version="1.0" encoding="UTF-8"?><!--Converted at: Mon May 19 13:26:13 KST 2014-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ChaMgmtDao">

    <!-- 페이징을 위한 header -->
    <sql id="paging_header">
		select *
		from (
		    select (ROW_NUMBER() OVER()) as rn, Z.*
		    from (	
	</sql>
    <!-- 페이징을 위한 footer -->
    <sql id="paging_footer">
		    ) Z
		) X where rn between #{start} and #{end}
	</sql>

    <!-- 사이 날짜 조회 -->
    <sql id="day_dt_between">
        <if test="@com.finger.shinhandamoa.common.CmmnUtils@notEmpty(calDateFrom) and @com.finger.shinhandamoa.common.CmmnUtils@notEmpty(calDateTo)">
            AND TO_CHAR(REGDT, 'YYYYMMDD') BETWEEN #{calDateFrom} AND #{calDateTo}
        </if>
    </sql>

    <!-- 기관검색 total count -->
    <select id="selChaListCnt" resultType="int">
        SELECT COUNT(*) AS cnt
        FROM XCHALIST
        WHERE 1 = 1
        <include refid="orgSearch"/>
    </select>

    <!-- 기관검색 -->
    <select id="selChaList" resultType="SysChaDTO">
        <include refid="paging_header"/>
        SELECT CHACD AS chacd
             , AGTCD AS agtcd --계약지점코드
             , mcht_id AS mchtId
             , CHANAME AS chaname --가맹점명
             , OWNER AS owner --대표자
             , OWNERTEL AS ownertel --대표전화번호
             , CHAOFFNO AS chaoffno --학원사업자번호
             , CHASTATUS AS chastatus --업종
             , CHATYPE AS chatype --업태
             , CHAADDRESS1 AS chaaddress1 --학원주소1
             , CHAADDRESS2 AS chaaddress2 --학원주소2
             , CHAZIPCODE AS chazipcode --우편번호
             , CHRNAME AS chrname --담당자명
             , CHRTELNO AS chrtelno --담당자전화번호
             , CHRHP AS chrhp --담당자핸드폰번호
             , CHRMAIL AS chrmail --담당자메일주소
        FROM XCHALIST
        WHERE 1 = 1
        <include refid="orgSearch"/>
        <include refid="paging_footer"/>
    </select>

    <sql id="orgSearch">
        <if test="chaCd != null and chaCd != ''">
            AND CHACD LIKE '%' || #{chaCd} || '%'
        </if>
        <if test="chaName != null and chaName != ''">
            AND CHANAME LIKE '%' || #{chaName} || '%'
        </if>
        <if test="searchGb != null and searchGb == 'new'">
            AND CHAST IN ('ST01', 'ST07')
        </if>
    </sql>

    <!-- 신규 기관 목록 total count -->
    <select id="selNewChaCount" resultType="int">
        SELECT COUNT(*) AS cnt
        FROM XCHALIST
        WHERE 1=1
        <if test="@com.finger.shinhandamoa.common.CmmnUtils@notEmpty(calDateFrom) and @com.finger.shinhandamoa.common.CmmnUtils@notEmpty(calDateTo)">
            AND BANK_REGI_DT BETWEEN #{calDateFrom} AND #{calDateTo}
        </if>
        <include refid="newChaSearch"/>
    </select>

    <!-- 신규 기관 목록 -->
    <select id="selNewChaList" resultType="SysChaDTO">
        <include refid="paging_header"/>
        SELECT TO_CHAR(REGDT, 'YYYY.MM.DD') AS regDt
        , CHACD AS chaCd
        , CHANAME AS chaName
        , CHRNAME AS chrName
        , CHRTELNO AS chrTelNo
        , AGTCD AS agtCd
        , CHA_CLOSE_CHK AS chaCloseChk
        , CHATRTY AS chatrty
        , CMS_FILE_NAME AS cmsFileName
        , PRECHAST AS prechast
        , CHAST AS chast
        , COALESCE(CHRMAIL, '') AS chrMail
        , DA_MNG_MEMO AS daMngMemo
        , CHAOFFNO AS chaOffNo
        , CHRHP AS chrHp
        , WITHDRAW_AGREEMENT_ID AS waId
        , AMTCHKTY AS amtchkTy
        , ACCNOCNT AS accNoCnt
        , limit_once AS limitOnce
        , limit_day AS limitDay
        , limit_day_cnt AS limitDayCnt
        , mcht_id AS mchtId
        , TO_CHAR(TO_DATE(BANK_ACPT_DT, 'YYYYMMDD'), 'YYYY.MM.DD') AS bnkAcptDt
        , TO_CHAR(TO_DATE(BANK_REGI_DT, 'YYYYMMDD'), 'YYYY.MM.DD') AS bnkRegiDt
        , TO_CHAR(TO_DATE(CHA_NEW_REG_DT, 'YYYYMMDD'), 'YYYY.MM.DD') AS chaNewRegDt
        FROM XCHALIST
        WHERE 1=1
        <if test="@com.finger.shinhandamoa.common.CmmnUtils@notEmpty(calDateFrom) and @com.finger.shinhandamoa.common.CmmnUtils@notEmpty(calDateTo)">
            AND BANK_REGI_DT BETWEEN #{calDateFrom} AND #{calDateTo}
        </if>
        <include refid="newChaSearch"/>
        <include refid="newChaOrderBy"/>
        <include refid="paging_footer"/>
    </select>

    <sql id="newChaSearch">
        <if test="chaCd != null and chaCd != ''">
            AND CHACD = #{chaCd}
        </if>
        <if test="chaName != null and chaName != ''">
            AND CHANAME = #{chaName}
        </if>
        <if test="@com.finger.shinhandamoa.common.CmmnUtils@notEmpty(amtchkTy)">
            <choose>
                <when test="amtchkTy == 'All'">
                    AND AMTCHKTY IN ('Y', 'N','L')
                </when>
                <when test="amtchkTy != 'All'">
                    AND AMTCHKTY = #{amtchkTy}
                </when>
            </choose>
        </if>
        <choose>
            <when test="@com.finger.shinhandamoa.common.CmmnUtils@notEmpty(chaStItem) and chaStItem == 'All'">
                AND CHAST IN ('ST01', 'ST07')
            </when>
            <when test="@com.finger.shinhandamoa.common.CmmnUtils@notEmpty(chaStItem) and chaStItem != 'All'">
                AND CHAST = #{chaStItem}
            </when>
            <otherwise>
                AND CHAST = 'ST01'
            </otherwise>
        </choose>
        <if test="@com.finger.shinhandamoa.common.CmmnUtils@notEmpty(chaCloseChk)">
            <choose>
                <when test="chaCloseChk == 'All'">
                    AND COALESCE(CHA_CLOSE_CHK, 'N') IN ('Y', 'N')
                </when>
                <when test="chaCloseChk != 'All'">
                    AND COALESCE(CHA_CLOSE_CHK, 'N') = #{chaCloseChk}
                </when>
            </choose>
        </if>
        <if test="@com.finger.shinhandamoa.common.CmmnUtils@notEmpty(chatrty)">
            <choose>
                <when test="chatrty == 'All'">
                    AND CHATRTY IN ('01', '03', '05')
                </when>
                <when test="chatrty != 'All'">
                    AND CHATRTY = #{chatrty}
                </when>
            </choose>
        </if>
    </sql>

    <sql id="newChaOrderBy">
        <if test="searchOrderBy != null and  searchOrderBy == 'regDt'">
            ORDER BY BANK_REGI_DT DESC, CHANAME, CHA_CLOSE_CHK, CHATRTY
        </if>
        <if test="searchOrderBy != null and  searchOrderBy == 'chaName'">
            ORDER BY CHANAME, BANK_REGI_DT DESC, CHA_CLOSE_CHK, CHATRTY
        </if>
        <if test="searchOrderBy != null and  searchOrderBy == 'chaCloseChk'">
            ORDER BY CHA_CLOSE_CHK, BANK_REGI_DT DESC, CHANAME, CHATRTY
        </if>
        <if test="searchOrderBy != null and  searchOrderBy == 'chaTrTy'">
            ORDER BY CHATRTY, BANK_REGI_DT DESC, CHANAME, CHA_CLOSE_CHK
        </if>
    </sql>

    <!-- 신규기관 정보 수정 -->
    <update id="updateChaInfo">
        UPDATE XCHALIST
        SET MAKEDT = NOW()
        , MAKER = #{maker}
        , CHAST = #{chast}
        , CHA_NEW_REG_DT = TO_CHAR(NOW(), 'YYYYMMDD')
<!--        <include refid="updateGubun"/>-->
        WHERE CHACD = #{chaCd}
    </update>

    <sql id="updateGubun">
        <choose>
            <when test="flag != null and flag == 1"><!-- 고객분류수정 -->
                , CHATRTY = #{chatrty}
            </when>
<!--            <when test="flag != null and flag == 2">&lt;!&ndash; 출금동의서 등록 &ndash;&gt;-->
<!--                , CMS_REQ_ST = #{cmsReqSt}-->
<!--                , CMS_REQ_DT = TO_CHAR(NOW(), 'YYYYMMDD')-->
<!--                , CMS_APP_GUBN = #{cmsAppGubn}-->
<!--                , CHKCMS = #{chkCms}-->
<!--                , CMS_FILE_NAME = #{cmsFileName}-->
<!--                , FINGER_FEE_AGREE_STATUS = #{finFeeAgreeSt}-->
<!--                , WITHDRAW_AGREEMENT_ID = #{withdrawAgreementId}-->
<!--            </when>-->
            <when test="flag  != null and flag == 3">
                , CHAST = #{chast}
                , CHA_NEW_REG_DT = TO_CHAR(NOW(), 'YYYYMMDD')
            </when>
            <when test="flag  != null and flag == 4">
                , DA_MNG_MEMO = #{daMngMemo}
            </when>
<!--            <when test="flag  != null and flag == 5">&lt;!&ndash; 해피콜 완료 &ndash;&gt;-->
<!--                , PRECHAST = #{preChast}-->
<!--            </when>-->
            <when test="flag  != null and flag == 6"><!-- 이용정지 -->
                , CHAST = #{chast}
            </when>
            <when test="flag  != null and flag == 7"><!-- 승인거부 -->
                , CHAST = #{chast}
                , CHA_NEW_REG_DT = ''
                , PRECHAST = '10'
                , CMS_REQ_ST = 'CST01'
                , CMS_REQ_DT = ''
                , CMS_APP_GUBN = ''
                , CHKCMS = 'N'
                , CMS_FILE_NAME = ''
                , FINGER_FEE_AGREE_STATUS = 'A00000'
                , WITHDRAW_AGREEMENT_ID = ''
            </when>
<!--            <when test="flag  != null and flag == 22">&lt;!&ndash; 출금동의서 삭제 &ndash;&gt;-->
<!--                ,CMS_REQ_ST = #{cmsReqSt}-->
<!--                ,CMS_REQ_DT = ''-->
<!--                ,CMS_APP_GUBN = #{cmsAppGubn}-->
<!--                ,CHKCMS = #{chkCms}-->
<!--                ,CMS_FILE_NAME = #{cmsFileName}-->
<!--                ,FINGER_FEE_AGREE_STATUS = #{finFeeAgreeSt}-->
<!--                ,WITHDRAW_AGREEMENT_ID = #{withdrawAgreementId}-->
<!--            </when>-->
        </choose>
    </sql>

    <insert id="insertWebUser">
	INSERT INTO WEBUSER(LOGINID,CHACD,LOGINPW,IDTYPE,MAKEDT,MAKER,REGDT,LOGINNAME,IDST)
	VALUES(#{loginid}, #{chacd}, #{loginpw}, #{idtype}, NOW(), #{maker}, now(), #{loginname}, #{idst})
	</insert>

    <!-- 다계좌 등록 및 수정 -->
    <insert id="insertXadjgroup" parameterType="map">
        INSERT INTO xadjgroup (chacd, adjfiregkey, grpadjname, maker, regdt, real_accno, bankcd)
        VALUES (#{chaCd}, #{adjfiregKey}, #{grpAdjName}, #{maker}, now(), #{realAccno}, #{bankCd})
        ON CONFLICT (chacd, adjfiregkey)
        DO UPDATE
              SET   grpadjname = #{grpAdjName}
                    , maker = #{maker}
                    , makedt = now()
                    , real_accno = #{realAccno}
                    , bankcd = #{bankCd}
    </insert>

    <!-- 다계좌 삭제 -->
    <delete id="deleteXadjgroup" parameterType="map">
        DELETE FROM xadjgroup
        WHERE chacd = #{chaCd} and adjfiregkey = #{adjfiregKey};

        UPDATE VA_SETTLE_MAS
        SET	ADJFIREGKEY = '00001'
          ,   MOD_DATE = NOW()
        WHERE CHACD = #{chaCd}
          AND SETTLE_STATUS IN ('W', 'F')
          AND ADJFIREGKEY = #{adjfiregKey};
    </delete>

    <delete id="deleteXchalist" parameterType="hashmap">
        DELETE FROM XCHALIST
        WHERE chacd = #{chaCd} ;

        DELETE FROM xadjgroup
        WHERE chacd = #{chaCd} ;

        DELETE FROM webuser
        WHERE chacd = #{chaCd} ;
    </delete>

    <!-- 가상계좌 정산목록 계좌번호 변경 -->
    <update id="updateSettleAccno">
        UPDATE VA_SETTLE_MAS
        SET	SETTLE_ACCNO = #{realAccno}
          , settle_bankcd = #{bankCd}
        ,   MOD_DATE = NOW()
        ,   MOD_NAME = #{maker}
        WHERE CHACD = #{chaCd}
        AND SETTLE_STATUS IN ('W', 'F')
        AND ADJFIREGKEY = #{adjfiregKey}
    </update>

    <!-- 이용기관조회내역 카운트 -->
    <select id="selChaCount" resultType="int">
        SELECT COUNT(*) AS CNT
        FROM XCHALIST A
            LEFT OUTER JOIN ( SELECT COUNT(*) AS RCNT, CHACD
                              FROM VALIST
                              WHERE 1 = 1
                              <if test="chaCd != null and chaCd != ''">
                                  AND CHACD = #{chaCd}
                              </if>
                              AND USEYN = 'N'
                              AND CUSCD IS NULL
                              GROUP BY CHACD ) B  ON A.CHACD = B.CHACD
            INNER JOIN WEBUSER C                  ON A.CHACD = C.CHACD
            LEFT OUTER JOIN XCHAGROUP D           ON A.CHAGROUPID = D.CHAGROUPID
            INNER JOIN KFTC_CODE E                ON A.FINGER_FEE_BANK_CODE = E.CODE
        WHERE 1=1
        <include refid="chaInfoSearch"/>
    </select>

    <!-- 이용기관조회 -->
    <select id="selChaInfoList" resultType="SysChaMgmtDTO">
        <include refid="paging_header"/>
        SELECT  TO_CHAR(A.REGDT, 'YYYY.MM.DD')                               AS regDt,
                A.FGCD                                                       AS fgCd,
                A.CHACD                                                      AS chaCd,
                A.CHANAME                                                    AS chaName,
                A.CHAOFFNO                                                   AS chaOffNo,
                A.CHATRTY                                                    AS chatrty,
                A.CHAST                                                      AS chast,
                A.OWNER                                                      AS owner,
                A.OWNERTEL                                                   AS ownerTel,
                A.USE_PURPOSE                                                AS usePurpose,
                A.CHASTATUS                                                  AS chaStatus,
                A.CHATYPE                                                    AS chaType,
                A.CHRNAME                                                    AS chrName,
                A.CHRTELNO                                                   AS chrTelNo,
                COALESCE(A.CHRMAIL, '')                                      AS chrMail,
                COALESCE(A.CHAZIPCODE, ' ')                                  AS chaZipCode,
                COALESCE(A.CHAADDRESS1, ' ')                                 AS chaAddress1,
                COALESCE(A.CHAADDRESS2, ' ')                                 AS chaAddress2,
                A.FINGER_FEE_BANK_CODE                                       AS fingerFeeBankCode,
                E.VALUE                                                      AS fingerFeeBankValue,
                A.FINGER_FEE_ACCOUNT_NO                                      AS fingerFeeAccountNo,
                A.FINGER_FEE_PAYTY                                           AS fingerFeePayty,
                A.ADJACCYN                                                   AS adjaccyn,
                A.PARTIAL_PAYMENT                                            AS partialPayment,
                A.AMTCHKTY                                                   AS amtChkTy,
                A.RCPREQYN                                                   AS rcpReqYn,
                A.MAND_RCP_YN                                                AS mandRcpYn,
                A.RCPREQTY                                                   AS rcpReqTy,
                A.NOTAXYN                                                    AS noTaxYn,
                A.RCPREQSVETY                                                AS rcpReqSveTy,
                A.MNLRCPREQTY                                                AS mnlRcpReqTy,
                COALESCE(B.RCNT, 0)                                          AS rCnt,
                C.LOGINID                                                    AS loginId,
                <if test="excel != null and excel != ''">
                ACC.acc                                                      AS accStr,
                </if>
                A.CHAGROUPID                                                 AS chaGroupId,
                D.CHAGROUPNAME                                               AS chaGroupName,
                A.limit_once AS limitOnce,
                A.limit_day AS limitDay,
                A.limit_day_cnt AS limitDayCnt,
                A.mcht_id AS mchtId,
                A.RCP_NOTICE_URL AS rcpNoticeUrl,
                A.CHA_API_URL_QUERY AS chaApiUrlQuery,
                A.CHA_API_URL_NOTICE AS chaApiUrlNotice
        FROM XCHALIST A
            LEFT OUTER JOIN ( SELECT COUNT(*) AS RCNT, CHACD
                              FROM VALIST
                              WHERE 1 = 1
                              <if test="chaCd != null and chaCd != ''">
                               AND CHACD = #{chaCd}
                              </if>
                              AND USEYN = 'N'
                              AND CUSCD IS NULL
                              GROUP BY CHACD ) B  ON A.CHACD = B.CHACD
            INNER JOIN WEBUSER C                  ON A.CHACD = C.CHACD
            LEFT OUTER JOIN XCHAGROUP D           ON A.CHAGROUPID = D.CHAGROUPID
            INNER JOIN KFTC_CODE E                ON A.FINGER_FEE_BANK_CODE = E.CODE
           <if test="excel != null and excel != ''">
            LEFT OUTER JOIN ( SELECT chacd, string_agg(account, ',') as acc
                              FROM (SELECT chacd,
                                    COALESCE((SELECT VALUE FROM KFTC_CODE WHERE CODE = bankcd),' ') ||'/'|| real_accno  AS account
                                    FROM xadjgroup
                                    ORDER BY chacd, adjfiregkey) temp
                              GROUP BY chacd ) ACC ON A.chacd=ACC.chacd
           </if>
        WHERE 1=1
        <include refid="chaInfoSearch"/>
        <include refid="chaInfoOrderBy"/>
        <include refid="paging_footer"/>
    </select>

    <sql id="chaInfoSearch">
        <if test="@com.finger.shinhandamoa.common.CmmnUtils@notEmpty(calDateFrom) and @com.finger.shinhandamoa.common.CmmnUtils@notEmpty(calDateTo)">
            AND TO_CHAR(A.REGDT,'YYYYMMDD') BETWEEN #{calDateFrom} AND #{calDateTo}
        </if>
        <if test="chaCd != null and chaCd != ''">
            AND A.CHACD LIKE '%' || #{chaCd} || '%'
        </if>
        <if test="chaName != null and chaName != ''">
            AND A.CHANAME LIKE '%' || #{chaName} || '%'
        </if>
        <if test="searchGb != null and searchGb =='chaOffNo' and searchValue != null and searchValue != ''">
            AND A.CHAOFFNO LIKE '%' ||#{searchValue}|| '%'
        </if>
        <if test="searchGb != null and searchGb =='owner' and searchValue != null and searchValue != ''">
            AND A.OWNER LIKE '%' || #{searchValue} || '%'
        </if>
        <if test="searchGb != null and searchGb =='chrTelNo' and searchValue != null and searchValue != ''">
            AND A.CHRTELNO LIKE '%' || #{searchValue} || '%'
        </if>
        <if test="chast == 'All'">
            AND A.CHAST IN ('ST02', 'ST06', 'ST08')
        </if>
        <if test="chast != 'All' and chast == 'ST06'">
            AND A.CHAST = 'ST06'
        </if>
        <if test="chast != 'All' and chast == 'ST08'">
            AND A.CHAST = 'ST08'
        </if>
        <if test="chast != 'All' and chast == 'ST02'">
            AND A.CHAST = 'ST02'
        </if>
        <if test="chatrty == 'All'">
            AND A.CHATRTY IN ('01', '03', '05', '07')
        </if>
        <if test="chatrty != 'All'">
            AND A.CHATRTY = #{chatrty}
        </if>
    </sql>

    <sql id="chaInfoOrderBy">
        <if test="searchOrderBy != null and  searchOrderBy == 'regDt'">
            ORDER BY A.REGDT DESC, A.CHACD, A.CHANAME
        </if>
        <if test="searchOrderBy != null and  searchOrderBy == 'chaCd'">
            ORDER BY A.CHACD, A.CHANAME
        </if>
        <if test="searchOrderBy != null and  searchOrderBy == 'chaName'">
            ORDER BY A.CHANAME, A.REGDT DESC, A.CHACD
        </if>
        <if test="searchOrderBy != null and  searchOrderBy == 'rCnt'">
            ORDER BY RCNT, A.REGDT DESC, A.CHACD
        </if>
    </sql>

    <!-- 담당자 핸드폰번호, 이메일 조회 -->
    <select id="selChrInfoList" resultType="SysChaDTO">
        SELECT CHACD AS chaCd
        , CHANAME AS chaName
        , COALESCE(CHRHP, '') AS chrHp
        , CHRMAIL AS chrMail
        , FINGER_FEE_OWNER_NO AS finFeeOwnNo
        , FINGER_FEE_BANK_CODE AS bnkCd
        FROM XCHALIST
        WHERE CHACD
        <choose>
            <when test="@com.finger.shinhandamoa.common.CmmnUtils@notEmpty(chaCd)">
                = #{chaCd}
            </when>
            <otherwise>
                in
                <foreach collection="stList" item="list" index="index" open="(" close=")" separator=",">
                    #{list}
                </foreach>
            </otherwise>
        </choose>
        <if test="flag != null and flag == '10'">
            AND CHRHP IS NOT NULL
        </if>
        <if test="flag != null and flag == '11' and ecareNo != '200'">
            AND CHRMAIL IS NOT NULL
        </if>
        ORDER BY CHA_NEW_REG_DT DESC, CHATRTY ASC, CHAST ASC
    </select>

    <!-- SMSSEQ 조회 -->
    <select id="selSmsSeq" resultType="int">
		SELECT	COALESCE(MAX(SMSSEQ), 0) + 1 	AS cnt
		FROM	SMS_SYS_LIST
	</select>

    <!-- SMS 발송 -->
    <insert id="insertSmsSysList">
		INSERT	INTO
		SMS_SYS_LIST(SMS_SYS_REQCD
				,	 SMSTY
				,	 SMSSEQ
				,	 CHACD
				,	 RCV_CHRHP
				,	 SEND_STATUS
				,	 REQDT)
		VALUES		(#{smsSysReqCd}
				,	 #{smsTy}
				,	 #{smsSeq}
				,	 #{chaCd}
				,	 #{rcvChrHp}
				,	 #{sendStatus}
				,	 NOW())
	</insert>

    <insert id="insertSmsSysMng">
		INSERT	INTO
		SMS_SYS_MNG(SMSTY
				,	SMSSEQ
				,	TITLE
				,	MSG
				,	SEND_TELNO
				,	MSGTY
				,	SEND_ID
				,	REQDT)
		VALUES	   (#{smsTy}
				,	#{smsSeq}
				,	#{title}
				,	#{msg}
				,	#{sendTelNo}
				,	#{msgTy}
				,	#{sendId}
				,	NOW())
	</insert>

    <!--임시작업이력테이블 실행여부 조회 -->
    <select id="selectJobhistoryLast" resultType="SysChaDTO">
        SELECT *
        FROM (SELECT STARTDATE AS startDate
                    , JOBID AS jobId
                    , ENDDATE AS endDate
                    , STATUS AS status
                    , TOTCNT AS totCnt
        FROM JOBHISTORY
        WHERE JOBID = #{jobId}
        <if test="status != null and status != ''">
            AND STATUS = #{status}
        </if>
        ORDER BY STARTDATE DESC)
        WHERE LIMIT 1
    </select>

    <!-- 휴폐업 조회 total count -->
    <select id="selCloseChaCount" resultType="int">
		SELECT 	COUNT(*)	AS cnt
		FROM 	XCHALIST
		WHERE 	CHA_CLOSE_CHK = 'Y' -- 휴폐업
	</select>

    <!-- 휴폐업 조회 목록 -->
    <select id="selCloseChaList" resultType="SysChaDTO">
        <include refid="paging_header"/>
        SELECT  TO_CHAR(TO_DATE(CHA_CLOSE_VAR_DT, 'YYYYMMDD'), 'YYYY.MM.DD') AS chaCloseVarDt
                , CHACD AS chaCd
                , CHANAME AS chaName
                , CHASTATUS AS chaStatus
                , CHATYPE AS chaType
                , CHRNAME AS chrName
                , CHRHP AS chrHp
                , CHAST AS chast
                , CHA_CLOSE_CHK AS chaCloseChk
                , CHA_CLOSE_ST AS chaCloseSt
                , CHA_CLOSE_VAR_RESON AS chaCloseVarReson
        FROM XCHALIST
        WHERE CHA_CLOSE_CHK = 'Y' -- 휴폐업
        <include refid="paging_footer"/>
    </select>

    <!-- 임시작업이력테이블 작업종료등록  -->
    <update id="updateJobhistory">
		UPDATE 	JOBHISTORY
		SET 	ENDDATE = TO_CHAR(NOW(), 'YYYYMMDDHH24MISS')
			, 	STATUS	= #{status}
			, 	TOTCNT	= #{totcnt}		   
		WHERE 	JOBID 	= #{jobid}
		AND 	STATUS	= #{targetstatus}		   	
	</update>

    <select id="countGroup" parameterType="map" resultType="long" useCache="false">
		SELECT COUNT(DISTINCT A.CHAGROUPID)
        FROM XCHAGROUP A
        <include refid="groupWhereClause"/>
    </select>

    <select id="selectGroup" parameterType="map" resultType="map" useCache="false">
		SELECT DISTINCT A.CHAGROUPID AS "id",
                A.CHAGROUPNAME AS "name",
                A.REMARK AS "remark",
                A.GRPST AS "status",
                A.GRPTRTY AS "transactionType",
                SUM(CASE WHEN B.CHACD IS NULL THEN  0  ELSE 1 END) OVER (PARTITION BY A.CHAGROUPID ORDER BY A.CHAGROUPNAME) AS "memberCount"
        FROM XCHAGROUP A
          LEFT OUTER JOIN XCHALIST B ON B.CHAGROUPID=A.CHAGROUPID
        <include refid="groupWhereClause"/>
        <choose>
            <when test="@org.apache.commons.lang3.StringUtils@isNotBlank(orderBy)">
                ORDER BY ${orderBy}
            </when>
            <otherwise>
                ORDER BY A.CHAGROUPNAME ASC
            </otherwise>
        </choose>
    </select>

    <sql id="groupWhereClause">
        WHERE 1=1
        AND A.CHAGROUPID LIKE '%' || #{groupId} || '%'
        AND A.CHAGROUPNAME LIKE '%' || #{groupName} || '%'
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(status)">
            AND A.GRPST = #{status}
        </if>
    </sql>

    <select id="nextChaGroupId" resultType="long">
        SELECT NEXTVAL('cha_group_id')
    </select>

    <select id="insertXChaGroup" parameterType="map">
        INSERT INTO XCHAGROUP (CHAGROUPID, CHAGROUPNAME, CHAGROUPPWD, REMARK, GRPST, GRPTRTY)
          VALUES (#{id}, #{name}, '0000000000000', #{remark}, #{status}, #{transactionType})
    </select>

    <select id="selectXChaGroupByGroupId" parameterType="string" resultType="map">
        SELECT *
        FROM XCHAGROUP A
        WHERE A.CHAGROUPID = #{groupId}
        LIMIT 1
    </select>

    <select id="selectWebUserByChaCd" parameterType="string" resultType="map">
        SELECT *
        FROM WEBUSER A
        WHERE A.CHACD = #{chaCd}
        LIMIT 1
    </select>

    <select id="selectXChaListByGroupId" parameterType="string" resultType="map">
        SELECT *
        FROM XCHALIST A
        WHERE A.CHAGROUPID=#{groupId}
    </select>

    <update id="blankChaGroupIdOnXChaList" parameterType="string">
        UPDATE XCHALIST
        SET CHAGROUPID=NULL
        WHERE CHACD=#{chaCd}
    </update>

    <select id="selectXChaList" parameterType="string" resultType="map">
        SELECT *
        FROM XCHALIST A
        WHERE A.CHAGROUPID IS NULL
          AND (
            A.CHANAME LIKE '%' || #{query} || '%'
            OR A.CHACD LIKE '%' || #{query} || '%'
          )
    </select>

    <update id="updateChaGroupIdOnXChaList" parameterType="map">
        UPDATE XCHALIST A
        SET CHAGROUPID = #{groupId}
        WHERE A.CHACD = #{chaCd}
    </update>

    <update id="updateXChaGroup" parameterType="map">
        UPDATE XCHAGROUP
        SET CHAGROUPNAME = #{name},
            GRPST = #{status},
            GRPTRTY = #{transactionType},
            REMARK = #{remark}
        WHERE CHAGROUPID = #{id}
    </update>

    <update id="updateWebUser" parameterType="map">
        UPDATE WEBUSER
        SET LOGINNAME = #{loginname},
        <if test="@org.apache.commons.lang3.StringUtils@isNotBlank(loginpw)">
            LOGINPW = #{loginpw},
        </if>
        IDST = #{idst}
        WHERE CHACD = #{chacd}
    </update>

    <update id="resetFailCntAdm" parameterType="map">
        UPDATE WEBUSER
        SET FAILCNT = 0
        WHERE CHACD = #{chaCd}
    </update>

    <update id="resetPwAdm" parameterType="map">
        UPDATE WEBUSER
        SET LOGINPW = #{loginPw}
        WHERE CHACD = #{chaCd}
    </update>

    <!-- 변경대기목록 total count -->
    <select id="getChangeChaListCnt" resultType="int">
        SELECT COUNT(*) AS cnt
        FROM (  SELECT *
                FROM DAMOA_CLIENT_INFO_PULL_HIST PULL
                LEFT JOIN XCHALIST X ON PULL.CLIENT_ID = X.CHACD
                WHERE 1=1
                <include refid="changeChaList"/>
            ) T1
    </select>

    <!-- 변경대기목록 -->
    <select id="getChangeChaList" resultType="SysChaDTO">
        <include refid="paging_header"/>
        SELECT TO_CHAR(TO_DATE(PULL.PULL_DT, 'YYYYMMDD'), 'YYYY.MM.DD') PULLDT
        , PULL.CLIENT_ID CLIENTID
        , PULL.CLIENT_NAME CLIENTNAME
        , PULL.TYPE_CD TYPECD
        , CASE PULL.TYPE_CD  WHEN 'C20001' THEN  '신규'  WHEN 'C20002' THEN  '변경'  WHEN 'C20003' THEN  '해지' END TYPENAME
        , PULL.STATUS_CD STATUSCD
        , CASE PULL.STATUS_CD  WHEN 'C10001' THEN  '대기'  WHEN 'C10002' THEN  '준비'  WHEN 'C10003' THEN  '실행중'  WHEN 'C10004' THEN  '성공'  WHEN 'C10005' THEN  '실패' END STATUSNAME
        , TO_CHAR(PULL.MODIFY_DATE, 'YYYY.MM.DD') MODIFYDT
        , X.CHACD CHACD
        , X.CHANAME CHANAME
        FROM DAMOA_CLIENT_INFO_PULL_HIST PULL LEFT JOIN XCHALIST X ON PULL.CLIENT_ID = X.CHACD
        WHERE 1=1
        <include refid="changeChaList"/>
        <include refid="paging_footer"/>
    </select>

    <!-- 변경대기목록 상세보기 -->
    <select id="changeChaListInfo" resultType="SysChaDTO">
        SELECT CLIENT_ID                CLIENTID
                , CLIENT_ID_NO           CLIENTIDNO
                , CLIENT_NAME            CLIENTNAME
                , CLIENT_STATUS          CLIENTSTATUS
                , CASE WHEN CLIENT_STATUS IN ('1', '2') THEN '정상'
                        WHEN CLIENT_STATUS IN ('3', '4') THEN '해지' END AS CLIENTSTATUSNAME
                , BRCH_CODE                             BRCHCODE
                , CASE  WHEN (CASE WHEN AGENCY1_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY1_STATUS IN ( '1', '2' ) THEN 'Y'
                        WHEN (CASE WHEN AGENCY1_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY1_STATUS IN ( '3', '4' ) THEN 'N'
                        ELSE 'N' END AS TOBECODE1
--                , NVL2(AGENCY1_CODE, 'Y', 'N')          TOBECODE1
                , COALESCE(AGENCY1_NAME, '-') TOBENAME1
                , CASE  WHEN (CASE WHEN AGENCY2_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY2_STATUS IN ( '1', '2' ) THEN 'Y'
                        WHEN (CASE WHEN AGENCY2_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY2_STATUS IN ( '3', '4' ) THEN 'N'
                        ELSE 'N' END AS TOBECODE2
--                 , NVL2(AGENCY2_CODE, 'Y', 'N')          TOBECODE2
                , COALESCE(AGENCY2_NAME, '-') TOBENAME2
                , CASE  WHEN (CASE WHEN AGENCY3_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY3_STATUS IN ( '1', '2' ) THEN 'Y'
                        WHEN (CASE WHEN AGENCY3_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY3_STATUS IN ( '3', '4' ) THEN 'N'
                        ELSE 'N' END AS TOBECODE3
--                 , NVL2(AGENCY3_CODE, 'Y', 'N')          TOBECODE3
                , COALESCE(AGENCY3_NAME, '-') TOBENAME3
                , CASE  WHEN (CASE WHEN AGENCY4_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY4_STATUS IN ( '1', '2' ) THEN 'Y'
                        WHEN (CASE WHEN AGENCY4_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY4_STATUS IN ( '3', '4' ) THEN 'N'
                        ELSE 'N' END AS TOBECODE4
--                 , NVL2(AGENCY4_CODE, 'Y', 'N')          TOBECODE4
                , COALESCE(AGENCY4_NAME, '-') TOBENAME4
                , CASE  WHEN (CASE WHEN AGENCY5_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY5_STATUS IN ( '1', '2' ) THEN 'Y'
                        WHEN (CASE WHEN AGENCY5_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY5_STATUS IN ( '3', '4' ) THEN 'N'
                        ELSE 'N' END AS TOBECODE5
--                 , NVL2(AGENCY5_CODE, 'Y', 'N')          TOBECODE5
                , COALESCE(AGENCY5_NAME, '-') TOBENAME5
                , CASE  WHEN (CASE WHEN AGENCY6_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY6_STATUS IN ( '1', '2' ) THEN 'Y'
                        WHEN (CASE WHEN AGENCY6_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY6_STATUS IN ( '3', '4' ) THEN 'N'
                        ELSE 'N' END AS TOBECODE6
--                 , NVL2(AGENCY6_CODE, 'Y', 'N')          TOBECODE6
                , COALESCE(AGENCY6_NAME, '-') TOBENAME6
                , CASE  WHEN (CASE WHEN AGENCY7_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY7_STATUS IN ( '1', '2' ) THEN 'Y'
                        WHEN (CASE WHEN AGENCY7_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY7_STATUS IN ( '3', '4' ) THEN 'N'
                        ELSE 'N' END AS TOBECODE7
--                 , NVL2(AGENCY7_CODE, 'Y', 'N')          TOBECODE7
                , COALESCE(AGENCY7_NAME, '-') TOBENAME7
                , CASE  WHEN (CASE WHEN AGENCY8_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY8_STATUS IN ( '1', '2' ) THEN 'Y'
                        WHEN (CASE WHEN AGENCY8_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY8_STATUS IN ( '3', '4' ) THEN 'N'
                        ELSE 'N' END AS TOBECODE8
--                 , NVL2(AGENCY8_CODE, 'Y', 'N')          TOBECODE8
                , COALESCE(AGENCY8_NAME, '-') TOBENAME8
                , CASE  WHEN (CASE WHEN AGENCY9_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY9_STATUS IN ( '1', '2' ) THEN 'Y'
                        WHEN (CASE WHEN AGENCY9_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY9_STATUS IN ( '3', '4' ) THEN 'N'
                        ELSE 'N' END AS TOBECODE9
--                 , NVL2(AGENCY9_CODE, 'Y', 'N')          TOBECODE9
                , COALESCE(AGENCY9_NAME, '-') TOBENAME9
                , CASE  WHEN (CASE WHEN AGENCY10_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY10_STATUS IN ( '1', '2' ) THEN 'Y'
                        WHEN (CASE WHEN AGENCY10_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y' and  AGENCY10_STATUS IN ( '3', '4' ) THEN 'N'
                        ELSE 'N' END AS TOBECODE10
--                 , NVL2(AGENCY10_CODE, 'Y','N')            TOBECODE10
                , COALESCE(AGENCY10_NAME, '-') TOBENAME10
                , PAYMENT_FEE_AMT        PAYMENTFEEAMT
                , FINGER_FEE_RATE        FINGERFEERATE
                , ASIS_CLIENT_ID_NO      ASISCLIENTIDNO
                , ASIS_CLIENT_NAME       ASISCLIENTNAME
                , ASIS_CLIENT_STATUS     ASISCLIENTSTATUS
                , CASE  WHEN ASIS_CLIENT_STATUS IN ('1', '2') THEN '정상'
                        WHEN ASIS_CLIENT_STATUS IN ('3', '4') THEN '해지' END AS ASISSTATUSNAME
                , ASIS_BRCH_CODE         ASISBRCHCODE
                , CASE WHEN ASIS_AGENCY1_CODE IS NOT NULL THEN 'Y' ELSE 'N' END                 ASISCODE1
                , COALESCE(ASIS_AGENCY1_NAME, '-')                                              ASISNAME1
                , CASE WHEN ASIS_AGENCY2_CODE IS NOT NULL THEN 'Y' ELSE 'N' END                 ASISCODE2
                , COALESCE(ASIS_AGENCY2_NAME, '-')                                              ASISNAME2
                , CASE WHEN ASIS_AGENCY3_CODE IS NOT NULL THEN 'Y' ELSE 'N' END                 ASISCODE3
                , COALESCE(ASIS_AGENCY3_NAME, '-')                                              ASISNAME3
                , CASE WHEN ASIS_AGENCY4_CODE IS NOT NULL THEN 'Y' ELSE 'N' END                 ASISCODE4
                , COALESCE(ASIS_AGENCY4_NAME, '-')                                              ASISNAME4
                , CASE WHEN ASIS_AGENCY5_CODE IS NOT NULL THEN 'Y' ELSE 'N' END                 ASISCODE5
                , COALESCE(ASIS_AGENCY5_NAME, '-')                                              ASISNAME5
                , CASE WHEN ASIS_AGENCY6_CODE IS NOT NULL THEN 'Y' ELSE 'N' END                 ASISCODE6
                , COALESCE(ASIS_AGENCY6_NAME, '-')                                              ASISNAME6
                , CASE WHEN ASIS_AGENCY7_CODE IS NOT NULL THEN 'Y' ELSE 'N' END                 ASISCODE7
                , COALESCE(ASIS_AGENCY7_NAME, '-')                                              ASISNAME7
                , CASE WHEN ASIS_AGENCY8_CODE IS NOT NULL THEN 'Y' ELSE 'N' END                 ASISCODE8
                , COALESCE(ASIS_AGENCY8_NAME, '-')                                              ASISNAME8
                , CASE WHEN ASIS_AGENCY9_CODE IS NOT NULL THEN 'Y' ELSE 'N' END                 ASISCODE9
                , COALESCE(ASIS_AGENCY9_NAME, '-')                                              ASISNAME9
                , CASE WHEN ASIS_AGENCY10_CODE IS NOT NULL THEN 'Y' ELSE 'N' END                ASISCODE10
                , COALESCE(ASIS_AGENCY10_NAME, '-')                                             ASISNAME10
                , ASIS_PAYMENT_FEE_AMT   ASISPAYMENTFEEAMT
                , ASIS_FINGER_FEE_RATE   ASISFINGERFEERATE
                , BRCH_CODE              BRCHCODE
                , ASIS_BRCH_CODE         ASISBRCHCODE
                , ( PAYMENT_FEE_AMT * FINGER_FEE_RATE ) / 100                PAYMENTFINERFEEAMT
                , ( ASIS_PAYMENT_FEE_AMT * ASIS_FINGER_FEE_RATE ) / 100      ASISPAYMENTFINERFEEAMT
                , ( SELECT F.AGTNAME
                      FROM FIAGTLIST F LEFT JOIN DAMOA_CLIENT_INFO_PULL_HIST D ON F.AGTCD = D.BRCH_CODE
                     WHERE CLIENT_ID = #{clientId} AND PULL_DT = #{pullDt} ) AS AGTNAME
                , ( SELECT F.AGTNAME
                      FROM FIAGTLIST F LEFT JOIN DAMOA_CLIENT_INFO_PULL_HIST D ON F.AGTCD = D.ASIS_BRCH_CODE
                    WHERE CLIENT_ID = #{clientId} AND PULL_DT = #{pullDt} ) AS ASISAGTNAME
                , CASE WHEN (CASE WHEN (CASE WHEN AGENCY1_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN AGENCY2_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN AGENCY3_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN AGENCY4_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN AGENCY5_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN AGENCY6_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN AGENCY7_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN AGENCY8_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN AGENCY9_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN AGENCY10_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                  THEN 'Y' END) IS NOT NULL THEN 'Y' ELSE 'N' END AS TOBEUSEYN
                , CASE WHEN (CASE WHEN (CASE WHEN ASIS_AGENCY1_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN ASIS_AGENCY2_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN ASIS_AGENCY3_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN ASIS_AGENCY4_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN ASIS_AGENCY5_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN ASIS_AGENCY6_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN ASIS_AGENCY7_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN ASIS_AGENCY8_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN ASIS_AGENCY9_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                    OR (CASE WHEN ASIS_AGENCY10_CODE IS NOT NULL THEN 'Y' ELSE 'N' END) = 'Y'
                                  THEN 'Y' END) IS NOT NULL THEN 'Y' ELSE 'N' END AS ASISUSEYN
                , CASE WHEN AGENCY2_STATUS IN ( '1', '2' ) OR AGENCY3_STATUS IN ( '1', '2' )
                          OR AGENCY4_STATUS IN ( '1', '2' ) OR AGENCY5_STATUS IN ( '1', '2' )
                          OR AGENCY6_STATUS IN ( '1', '2' ) OR AGENCY7_STATUS IN ( '1', '2' )
                          OR AGENCY8_STATUS IN ( '1', '2' ) OR AGENCY9_STATUS IN ( '1', '2' )
                          OR AGENCY10_STATUS IN ( '1', '2' ) THEN 'Y' ELSE 'N' END AS AGENCYSTATUS
                , (SELECT ADJACCYN FROM XCHALIST WHERE CHACD = #{clientId}) AS adjAccYn
         FROM DAMOA_CLIENT_INFO_PULL_HIST
        WHERE CLIENT_ID = #{clientId}
          AND PULL_DT = #{pullDt}
    </select>

    <!-- 변경대기목록 실행버튼 -->
    <update id="updateChangeChaInfo">
        UPDATE DAMOA_CLIENT_INFO_PULL_HIST
           SET STATUS_CD = 'C10002'
         WHERE CLIENT_ID = #{clientId}
           AND PULL_DT = #{pullDt}
    </update>


    <select id="pgUpdateChaInfoListCnt" parameterType="com.finger.shinhandamoa.sys.setting.dto.ChaUpdateDTO" resultType="int">
        select count(*) as cnt
        from pg_client_info_pull_hist
        where 1=1
        <if test='startDate != null and startDate != ""'>
            AND pull_dt <![CDATA[ >= ]]> #{startDate}
        </if>
        <if test='endDate != null and endDate != ""'>
            AND pull_dt <![CDATA[ <= ]]> #{endDate}
        </if>
    </select>

    <select id="pgUpdateChaInfoList" parameterType="com.finger.shinhandamoa.sys.setting.dto.ChaUpdateDTO" resultType="com.finger.shinhandamoa.sys.setting.dto.ChaUpdateDTO">
        <include refid="paging_header"/>
        select pgpullseq                     as pgPullSeq, /*pg변경전문시퀀스*/
        pull_dt  as pullDt, /*pg변경전문 요청일자*/
        mcht_id                       as mchtId, /*pg가맹점아이디*/
        chacd                         as chaCd, /*pg기관코드*/
        client_id_no                  as clientIdNo,
        limit_day                     as limitDay, /*일 입금 제한 금액*/
        limit_day_cnt                 as limitDayCnt, /*일 제한 횟수*/
        limit_once                    as limitOnce, /*한번에 입금가능금액*/
        amtchkty                      as amtchkty, /*Y승인 N 통지 L 한도*/
        reg_dt                        as regDt, /*DB입력기간*/
        TO_CHAR(assigndt, 'YYYYMMDD') as assignDt, /*승인일자*/
        assignyn                      as assignYn /*승인여부*/
        from pg_client_info_pull_hist
        WHERE 1 = 1
        <if test='startDate != null and startDate != ""'>
            AND pull_dt <![CDATA[ >= ]]> #{startDate}
        </if>
        <if test='endDate != null and endDate != ""'>
            AND pull_dt <![CDATA[ <= ]]> #{endDate}
        </if>
        order by pull_dt desc
        <include refid="paging_footer"/>

    </select>

    <select id="pgUpdateChaBefore" parameterType="com.finger.shinhandamoa.sys.setting.dto.ChaUpdateDTO" resultType="com.finger.shinhandamoa.sys.setting.dto.ChaUpdateDTO">
        select pgpullseq        as pgPullSeq, /*pg변경전문시퀀스*/
               pull_dt          as pullDt, /*pg변경전문 요청일자*/
               mcht_id          as mchtId, /*pg가맹점아이디*/
               chacd            as chaCd, /*기관코드*/
               client_id_no     as clientIdNo,
               limit_day        as limitDay, /*일 입금 제한 금액*/
               limit_day_cnt    as limitDayCnt, /*일 제한 횟수*/
               limit_once       as limitOnce, /*한번에 입금가능금액*/
               amtchkty         as amtchkty, /*Y승인 N 통지 L 한도*/
               reg_dt           as regDt, /*DB입력기간*/
               assigndt         as assignDt, /*승인일자*/
               assignyn         as assignYn /*승인여부*/
        from pg_client_info_pull_hist
        WHERE 1 = 1
          AND pgpullseq = #{pgPullSeq}
    </select>

    <update id="pgUpdateCha" parameterType="com.finger.shinhandamoa.sys.setting.dto.ChaUpdateDTO">
        UPDATE XCHALIST
        SET limit_day = #{limitDay}, /*일 입금 제한 금액*/
            limit_day_cnt = #{limitDayCnt}, /*일 제한 횟수*/
            limit_once = #{limitOnce}, /*한번에 입금가능금액*/
            amtchkty = #{amtchkty}, /*Y승인 N 통지 L 한도*/
            rcp_due_chk = #{rcpDueChk} /*수납 기간 체크 여부 Y, N*/
        WHERE chacd = #{chaCd} /*기관코드*/
    </update>

    <update id="pgUpdateChaAfter" parameterType="com.finger.shinhandamoa.sys.setting.dto.ChaUpdateDTO">
        UPDATE pg_client_info_pull_hist
        SET assigndt = now(),
            assignyn = 'Y'
        WHERE pgpullseq = #{pgPullSeq}
    </update>






    <sql id="changeChaList">
        <if test="@com.finger.shinhandamoa.common.CmmnUtils@notEmpty(calDateFrom) and @com.finger.shinhandamoa.common.CmmnUtils@notEmpty(calDateTo)">
            AND TO_DATE(PULL.PULL_DT, 'YYYYMMDD') BETWEEN #{calDateFrom} AND #{calDateTo}
        </if>
        <if test="@com.finger.shinhandamoa.common.CmmnUtils@notEmpty(chaCd)">
            AND X.CHACD LIKE '%' || #{chaCd} || '%'
        </if>
        <if test="@com.finger.shinhandamoa.common.CmmnUtils@notEmpty(chaName)">
            AND X.CHANAME LIKE '%' || #{chaName} || '%'
        </if>
        <if test="@com.finger.shinhandamoa.common.CmmnUtils@notEmpty(typeCd)">
            AND PULL.TYPE_CD IN (#{typeCd})
        </if>
        <if test="@com.finger.shinhandamoa.common.CmmnUtils@notEmpty(statusCd)">
            AND PULL.STATUS_CD IN (#{statusCd})
        </if>
        <if test="searchOrderBy != null and  searchOrderBy == 'pullDt'">
            ORDER BY PULL.PULL_DT DESC, X.CHANAME, X.CHACD, PULL.MODIFY_DATE DESC
        </if>
        <if test="searchOrderBy != null and  searchOrderBy == 'clientName'">
            ORDER BY X.CHANAME, X.CHACD, PULL.PULL_DT DESC, PULL.MODIFY_DATE DESC
        </if>
        <if test="searchOrderBy != null and  searchOrderBy == 'modifyDt'">
            ORDER BY PULL.MODIFY_DATE DESC, PULL.PULL_DT DESC, X.CHANAME, X.CHACD
        </if>
    </sql>
</mapper>
